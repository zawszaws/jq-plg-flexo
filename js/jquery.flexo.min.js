/**
 * jQuery Flexo
 * jQuery plugin that makes gmail-like popup windows
 *
 * Copyright 2013 Vladimir Anokhin (gndev.info)
 *
 * Released under the GPL License.
 *
 * ------------------------------------------------
 *  version: 1.0.0
 *  author: Vladimir Anokhin
 *  source: https://github.com/gndev/flexo
 */;
(function(e,t,n,r){var i=function(t,n){this.elem=t;this.$elem=e(t);this.options=n;this.metadata=e.parseJSON((this.$elem.attr("data-flexo")||"").replace(/'/g,'"'));this.event("before_init");this.init();this.event("ready")};i.prototype={defaults:{id:false,type:"html",width:200,height:300,show:true,minimized:false,fullscreen:false,overlay:false,overlayConfig:{opacity:.8,color:"white",click2close:true,esc2close:true},zIndex:1e5,controls:{drag:true,resize:true,minify:true,fullscreen:true,close:true},title:"",content:"",footer:"",footerConfig:{height:40},size:"normal",destroyClosed:true,stackMinimized:false,position:"center",theme:{title:"#464646",titleText:"#fff",controls:"white",border:"none",background:"#fff",footer:"#f5f5f5",shadow:"0 5px 25px #333"},ajax:{type:"post",url:false,data:{},dataType:"html"},draggableConfig:{handle:".flexo-header",cancel:".flexo-controls",iframeFix:".flexo-iframe",containment:"window",stack:"body",scroll:false},resizableConfig:{containment:"document"},mobile:{fullscreen:true,scroll:true}},init:function(){var t=this.utils;if(t.isset(this.$elem.attr("id")))this.defaults.id=this.$elem.attr("id");if(t.isset(this.$elem.attr("title")))this.defaults.title=this.$elem.attr("title");if(t.isset(this.$elem.html()))this.defaults.content=this.$elem.html();this.config=e.extend(true,{},this.defaults,this.options,this.metadata);if(!this.config.id)this.config.id=e(".flexo-container").length;if(!this.config.ajax.url)this.config.ajax.url=this.config.content;this.$elem.hide();this.create();this.$elem.data("_flexo",this)},create:function(){var t=e("<div />"),n,r=this.config,i=this.utils,s=r.id,o="";if(this.getWindow(s).length>0){this.destroy(s);console.log('Flexo: detected identical windows with the same ID "%s", rendered only last called window!',s)}e.each(["minify","fullscreen","close"],function(e,t){if(r.controls[t])o+='<span class="flexo-control-'+t+'"></span>'});t.attr("id","flexo-window-"+r.id);t.attr("class","flexo-container flexo-size-"+r.size+" flexo-type-"+r.type);if(r.overlay)t.addClass("flexo-has-overlay");if(r.footer)t.addClass("flexo-has-footer");t.css({width:i.size(r.width,"w")+"px",height:i.size(r.height,"h")+"px",zIndex:parseInt(r.zIndex)+1,boxShadow:r.theme.shadow,position:"fixed"});if(i.isset(r.theme.background))t.css("background",r.theme.background);if(i.isset(r.theme.border))t.css("border",r.theme.border);n='<div class="flexo-header" style="background: '+r.theme.title+"; color: "+r.theme.titleText+'"><div class="flexo-title" title="'+r.title+'">'+r.title+"</div></div>";n+='<div class="flexo-controls flexo-controls-'+r.theme.controls+'">'+o+"</div>";n+='<div class="flexo-content"></div>';if(i.isset(r.footer))n+='<div class="flexo-footer" style="background:'+r.theme.footer+"; height: "+(new String(r.footerConfig.height)).replace("px","")+'px;"><div class="flexo-footer-inner">'+r.footer+"</div></div>";t.html(n).appendTo("body");this.$window=this.getWindow(s);this.handlers();this.position();if(r.overlay){this.overlay("create");this.overlay("show")}if(r.show)this.show();if(r.controls.drag)this.draggable();if(r.controls.resize)this.resizable();if(r.minimized)this.minimize();if(r.fullscreen||typeof e.browser.mobile==="boolean"&&e.browser.mobile&&r.mobile.fullscreen)this.fullscreen();if(typeof e.browser.mobile==="boolean"&&e.browser.mobile&&r.mobile.scroll)e("html, body").animate({scrollTop:0},100,function(){e("html, body").animate({scrollLeft:0},100)});this.update();this.getWindow(s).data("_flexo",this);this.event("created")},getWindow:function(t){var n=this.$window;if(t)n=e("#flexo-window-"+t);else if(typeof n==="object")n=n;else n=e("#flexo-window-"+this.config.id);return n},update:function(t){var n=this,r=n.getWindow(),i=n.utils,s=t?e.extend(true,{},n.config,t):n.config,o=s.type,u="",a="flexo-iframe-"+s.id;switch(o){case"html":if(i.strpos(s.content,"#")===0)s.content=e(s.content).html();u='<div class="flexo-html-content">'+s.content+"</div>";break;case"image":u='<img src="'+s.content+'" alt="'+s.title+'" class="flexo-image" />';break;case"iframe":u='<iframe id="'+a+'" src="'+s.content+'" class="flexo-iframe"></iframe>';break;case"ajax":u='<div class="flexo-loading"></div>';s.ajax.success=function(e){r.find(".flexo-content").html(e);n.event("loaded")};e.ajax(s.ajax);break}r.find(".flexo-title").html(s.title);r.find(".flexo-content").html(u);r.find(".flexo-footer").html(s.footer);this.resizeContent();this.event("updated")},handlers:function(){var n=this,r=this.getWindow(),i=null;r.on("click",".flexo-control-minify",function(e){if(r.hasClass("flexo-minimized"))n.expand();else n.minimize();e.preventDefault();e.stopPropagation()});r.on("click",".flexo-control-fullscreen",function(e){if(r.hasClass("flexo-fullscreen"))n.normalscreen();else n.fullscreen();e.preventDefault();e.stopPropagation()});r.on("click",".flexo-control-close",function(e){n.close();e.preventDefault();e.stopPropagation()});e(t).on("resize",function(e){if(e.target!=t)return;clearTimeout(i);i=setTimeout(function(){n.position(false,true);n.resizeContent()},200)})},position:function(n,r,i){if(r)this.config.position=r;i=i?i:false;var s=this,o={width:e(t).width(),height:e(t).height()};this.config.width=this.utils.size(this.config.width,"w");this.config.height=this.utils.size(this.config.height,"h");if(this.config.width>o.width||this.config.height>o.height){setTimeout(function(){s.fullscreen()},500)}var u=this.config,a=this.getWindow(n),f=this.utils,l=f.size(u.width,"w"),c=f.size(u.height,"h");if(u.position==="center"){if(i)a.animate({left:(o.width-l)/2,top:(o.height-c)/2},200);else a.css({left:(o.width-l)/2,top:(o.height-c)/2})}else if(typeof u.position==="object")e.each(["top","right","bottom","left"],function(e,t){var n=u.position[t];if(f.isset(n))a.css(t,f.is_numeric(n)?n+"px":n)})},resizeContent:function(){var e=this.$window,t=this.config,n=30,r=t.footer?(new String(t.footerConfig.height)).replace("px",""):0,i=e.width(),s=e.height()-n-r;e.find(".flexo-content").css({width:i+"px",height:s+"px"})},show:function(e){var t=this.getWindow(e);if(this.config.overlay)this.overlay("show");t.addClass("flexo-visible");this.event("show")},hide:function(e){var t=this.getWindow(e);if(t.hasClass("flexo-has-overlay"))this.overlay("hide");t.removeClass("flexo-visible");this.event("hide")},close:function(e){if(this.config.destroyClosed)this.destroy(e);else this.hide(e);this.event("close")},minimize:function(e){this.normalscreen(e);this.getWindow(e).addClass("flexo-minimized");this.resizable(false);this.event("minimize")},expand:function(e){this.getWindow(e).removeClass("flexo-minimized");if(this.config.controls.resize)this.resizable();this.event("expand")},fullscreen:function(n){this.expand(n);var r=this.getWindow(n),i=this.config,s=30,o=i.footer?(new String(i.footerConfig.height)).replace("px",""):0,u=r.width(),a=r.height()-s-o,f=e(t).width(),l=e(t).height()-s-o;r.attr("data-original-content-width",u);r.attr("data-original-content-height",a);r.addClass("flexo-fullscreen").css({zIndex:this.config.zIndex+100}).find(".flexo-content").css({width:f+"px",height:l+"px"});this.resizable(false);this.draggable(false);this.event("fullscreen")},normalscreen:function(e){var t=this.getWindow(e),n=this.config;original_height=t.attr("data-original-content-height");t.removeClass("flexo-fullscreen").css({zIndex:n.zIndex});this.position(false,true);this.resizeContent();if(n.controls.resize)this.resizable();if(n.controls.drag)this.draggable();this.event("normalscreen")},overlay:function(n,r){var i=this,s=i.config,o="flexo-overlay-"+(r||s.id),u=e("#"+o);if(n==="create"&&u.length<1){e("<div></div>").attr("id",o).addClass("flexo-overlay").css({background:s.overlayConfig.color,opacity:s.overlayConfig.opacity,zIndex:s.zIndex}).appendTo("body");u=e("#"+o);if(s.overlayConfig.click2close)u.on("click",function(e){i.close();e.preventDefault();e.stopPropagation()});if(s.overlayConfig.esc2close)e(t).on("keyup",function(e){if(e.keyCode==27)i.close();e.preventDefault();e.stopPropagation()})}else if(n==="destroy")u.off().remove();else if(n==="show")u.addClass("flexo-overlay-visible");else if(n==="hide")u.removeClass("flexo-overlay-visible")},draggable:function(t){if(typeof e.fn.draggable!=="function")return;var n=this.config,r=this.$window,i=this.utils;t=i.isset(t)?t:true;if(!i.isset(n.draggableConfig.start))n.draggableConfig.start=function(e,t){r.addClass("flexo-dragged");r.css({zIndex:n.zIndex+1})};if(t)r.draggable(n.draggableConfig);else r.draggable("destroy")},resizable:function(n){if(typeof e.fn.resizable!=="function")return;var r=this,i=this.config,s=this.$window,o=this.utils;n=o.isset(n)?n:true;if(!o.isset(i.resizableConfig.resize))i.resizableConfig.resize=function(e,t){r.resizeContent()};if(!o.isset(i.resizableConfig.stop))i.resizableConfig.stop=function(n,r){s.css({position:"fixed",top:s.position().top-e(t).scrollTop()+"px"})};if(n)s.resizable(i.resizableConfig);else s.resizable("destroy")},destroy:function(e){var t=this.getWindow(e);if(t.hasClass("flexo-has-overlay"))this.overlay("destroy");t.off();t.remove();this.event("destroy")},setContent:function(e){this.update({content:e})},event:function(e){this.$elem.trigger(e+".flexo")},utils:{is_numeric:function(e){return!isNaN(e)},isset:function(e){return e!==r&&e!==null&&e!==""},strpos:function(e,t,n){var r=e.indexOf(t,n);return r>=0?r:false},size:function(n,r){var i=new String(n),s=r=="w"?e(t).width():e(t).height(),o=0;if(this.strpos(i,"%"))o=s/100*i.replace("%","");else o=i.replace("px","");return parseInt(o)}}};i.defaults=i.prototype.defaults;e.flexo=function(e){var t=null,r=n.createElement("div");if(typeof e==="object"||!e)t=new i(r,e);else console.error("Flexo: please specify at least the type and content");return t};e.fn.flexo=function(t){var n=null,r=Array.prototype.slice.call(arguments,1);if(this.length==0)n=null;else if(typeof i.prototype[t]==="function")n=this.each(function(){i.prototype[t].apply(e(this).data("_flexo"),r)});else if(typeof t==="object"||!t)n=this.each(function(){new i(this,t)});else console.error('Flexo: "%s" is not correct method name!',t);return n};t.Flexo=i})(jQuery,window,document);jQuery(document).ready(function(e){e(".flexo-link").live("click",function(t){e(e(this).attr("href")).flexo();t.preventDefault()})});